<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Excel/CSV to JSON 변환기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        #drop-area {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #drop-area.highlight {
            border-color: purple;
        }
        #fileElem {
            display: none;
        }
        .tab-content {
            margin-top: 20px;
            display: none;
        }
        #file-name {
            margin-top: 10px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .tab-pane {
            border: 1px solid #ddd;
            border-top: none;
            padding: 20px;
            margin-bottom: 20px;
        }
        .nav-tabs {
            border-bottom: none;
        }
        .tab-content .tab-pane {
            border-top: 1px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .json-buttons {
            display: none;
        }
        .conversion-controls {
            display: none;
            margin-top: 20px;
        }
        .conversion-controls .form-group {
            display: inline-block;
            margin-right: 10px;
        }
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div id="drop-area">
        <p>여기에 Excel 또는 CSV 파일을 드래그 앤 드롭하세요</p>
    </div>
    <div class="container">
        <div class="header-container">
            <h1>Excel/CSV to JSON 변환기</h1>
            <div>
                <span id="file-name"></span>
                <label class="btn btn-primary" for="fileElem">파일 선택</label>
                <input type="file" id="fileElem" accept=".xlsx,.xls,.csv" onchange="handleFiles(this.files)">
            </div>
        </div>
        <div class="conversion-controls">
            <div class="form-group">
                <select class="form-control" id="sheet-select" onchange="displaySheet()">
                    <option value="" disabled hidden selected>시트 선택</option>
                    <!-- 시트 목록이 여기에 추가됩니다 -->
                </select>
            </div>
            <div class="form-group">
                <select class="form-control" id="conversion-method">
                    <option value="" disabled hidden selected>변환 방법 선택</option>
                    <option value="json-method1">JSON 방법 1</option>
                    <option value="json-method2">JSON 방법 2</option>
                    <!-- 필요한 경우 더 많은 방법 추가 -->
                </select>
            </div>
            <button class="btn btn-success" onclick="convertToJSON()">JSON으로 변환</button>
        </div>
        <div class="tab-content">
            <div class="d-flex justify-content-between">
                <ul class="nav nav-tabs" id="resultTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="table-tab" data-bs-toggle="tab" href="#table" role="tab" aria-controls="table" aria-selected="true">표</a>
                    </li>
                    <li class="nav-item json-tab" style="display: none;">
                        <a class="nav-link" id="json-tab" data-bs-toggle="tab" href="#json" role="tab" aria-controls="json" aria-selected="false">JSON</a>
                    </li>
                </ul>
                <div class="tab-buttons json-buttons">
                    <button class="btn btn-primary" onclick="copyJSON()">JSON 복사</button>
                    <button class="btn btn-secondary" onclick="saveJSON()">JSON 저장</button>
                </div>
            </div>
            <div class="tab-pane fade show active" id="table" role="tabpanel" aria-labelledby="table-tab">
                <div id="table-container"></div>
            </div>
            <div class="tab-pane fade" id="json" role="tabpanel" aria-labelledby="json-tab">
                <pre id="json-output"></pre>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        let selectedFile;
        let workbook;
        let dragCounter = 0;

        $(document).on('dragenter', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragCounter++;
            $('#drop-area').show().addClass('highlight');
        });

        $(document).on('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragCounter--;
            if (dragCounter === 0) {
                $('#drop-area').hide().removeClass('highlight');
            }
        });

        $(document).on('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
        });

        $(document).on('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragCounter = 0;
            $('#drop-area').hide().removeClass('highlight');
            handleFiles(event.originalEvent.dataTransfer.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                $('#file-name').text(`선택된 파일: ${selectedFile.name}`);
                console.log('File selected:', selectedFile.name);
                $('.tab-content').hide();
                $('.json-tab').hide();
                $('.json-buttons').hide();
                $('.conversion-controls').hide();
                loadFile();
            }
        }

        function loadFile() {
            const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = event.target.result;
                if (fileExtension === 'csv') {
                    workbook = XLSX.read(data, { type: 'string' });
                } else {
                    workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                }
                populateSheetSelect();
            };
            if (fileExtension === 'csv') {
                reader.readAsText(selectedFile);
            } else {
                reader.readAsArrayBuffer(selectedFile);
            }
        }

        function populateSheetSelect() {
            const sheetSelect = $('#sheet-select');
            sheetSelect.empty();
            sheetSelect.append($('<option>', {
                value: '',
                text: '시트 선택',
                disabled: true,
                hidden: true,
                selected: true
            }));
            workbook.SheetNames.forEach((sheetName, index) => {
                sheetSelect.append(new Option(sheetName, index));
            });
            $('.conversion-controls').show();
        }

        function displaySheet() {
            const sheetIndex = $('#sheet-select').val();
            if (sheetIndex === '') return;
            const worksheet = workbook.Sheets[workbook.SheetNames[sheetIndex]];
            const tableHTML = XLSX.utils.sheet_to_html(worksheet);
            $('#table-container').html(tableHTML);
            $('#table-container table').addClass('table table-striped table-bordered');
            $('.tab-content').show();
        }

        function convertToJSON() {
            const sheetIndex = $('#sheet-select').val();
            if (sheetIndex === '') return;
            const worksheet = workbook.Sheets[workbook.SheetNames[sheetIndex]];
            const method = $('#conversion-method').val();
            if (method === '') return;
            let json;
            if (method === 'json-method1') {
                json = XLSX.utils.sheet_to_json(worksheet);
            } else if (method === 'json-method2') {
                json = customSheetToJson(worksheet);
            }
            $('#json-output').text(JSON.stringify(json, null, 2));
            $('.json-tab').show();
            $('.json-buttons').show();
            $('#json-tab').tab('show');
        }

        function customSheetToJson(worksheet) {
            const json = [];
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const row = {};
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (worksheet[cell_ref]) {
                        row[cell_ref] = worksheet[cell_ref].v;
                    }
                }
                json.push(row);
            }
            return json;
        }

        function copyJSON() {
            const jsonOutput = $('#json-output').text();
            navigator.clipboard.writeText(jsonOutput).then(() => {
                alert('JSON이 클립보드에 복사되었습니다.');
            });
        }

        function saveJSON() {
            const jsonOutput = $('#json-output').text();
            const blob = new Blob([jsonOutput], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>