<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>데이터 변환 도구</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            font-size: 14px;
        }
        #drop-area {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #drop-area.highlight {
            border-color: purple;
        }
        #fileElem {
            display: none;
        }
        .tab-content {
            margin-top: 20px;
            display: none;
        }
        .tab-pane {
            border: 1px solid #ddd;
            border-top: none;
            padding: 20px;
            margin-bottom: 20px;
        }
        .nav-tabs {
            border-bottom: none;
        }
        .tab-content .tab-pane {
            border-top: 1px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
            position: relative;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .json-buttons, .php-buttons {
            display: none;
        }
        .conversion-controls {
            display: none;
            margin-top: 20px;
        }
        .conversion-controls .form-group {
            display: inline-block;
            margin-right: 10px;
        }
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .title-and-help {
            display: flex;
            align-items: center;
            gap: 10px; /* 제목과 사용 방법 버튼 사이 간격 */
        }
        .file-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* 파일 이름과 파일 선택 버튼 사이 간격 */
        }
        #file-name {
            font-weight: bold;
        }
        .selected {
            background-color: #FFD580 !important;
        }
        .data-row {
            background-color: #FFFACD !important;
        }
        .key-icon {
            position: relative; /* 기존 absolute에서 relative로 변경 */
            margin-left: 5px; /* 아이콘과 텍스트 간격 추가 */
            color: #FF6347; /* 아이콘 색상 */
            font-size: 14px; /* 아이콘 크기 */
            vertical-align: middle; /* 텍스트와 수직 정렬 */
        }
        .json-buttons .btn, .php-buttons .btn {
            font-size: 12px;
            padding: 5px 10px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            z-index: 1000;
        }
        #scrollToTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            z-index: 1000;
            border: none;
            outline: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        #scrollToTopBtn:hover {
            background-color: #0056b3;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .swal2-header-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        font-size: 14px;
        }
        .swal2-header-label {
            flex: 1;
            text-align: right;
            margin-right: 5px;
        }
        .swal2-header-input {
            flex: 2;
            padding: 5px 10px;
        }
        .swal2-header-input[readonly] {
            background-color: #f8f9fa;
            border: none;
            cursor: not-allowed;
        }
        .swal2-header-input.error {
            background-color: #ffcccc;
        }
        .swal2-header-checkbox {
            width: 20px; /* 체크박스 크기 */
            height: 20px; /* 체크박스 크기 */
            margin-left: 5px; /* 인풋박스와의 간격 */
            vertical-align: middle; /* 체크박스 정렬 */
        }
    </style>
</head>
<body>
    <div id="drop-area">
        <p>여기에 Excel, CSV 또는 XML 파일을 드래그 앤 드롭하세요</p>
    </div>
    <div id="loading-overlay">
        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="header-container">
            <div class="title-and-help">
                <h1>데이터 변환 도구</h1>
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#usageModal">
                    <i class="fas fa-info-circle"></i> 사용 방법
                </button>
            </div>
            <div class="file-actions">
                <span id="file-name">파일 이름 없음</span>
                <label class="btn btn-primary" for="fileElem"><i class="fas fa-file-upload"></i> 파일 선택</label>
                <input type="file" id="fileElem" accept=".xlsx,.xlsm,.xls,.csv,.xml" onchange="handleFiles(this.files)">
            </div>
        </div>
        <div class="conversion-controls">
            <div class="form-group">
                <select class="form-control" id="sheet-select" onchange="executeWithLoading(displaySheet)">
                    <option value="" disabled hidden selected>시트 선택</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="executeWithLoading(convertToJSON)"><i class="fas fa-file-code"></i> JSON으로 변환</button>
            <button class="btn btn-warning" onclick="executeWithLoading(convertToPHP)"><i class="fas fa-code"></i> PHP코드로 변환</button>
        </div>
        <div class="tab-content">
            <div class="d-flex justify-content-between">
                <ul class="nav nav-tabs" id="resultTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="table-tab" data-bs-toggle="tab" href="#table" role="tab" aria-controls="table" aria-selected="true">표</a>
                    </li>
                    <li class="nav-item json-tab" style="display: none;">
                        <a class="nav-link" id="json-tab" data-bs-toggle="tab" href="#json" role="tab" aria-controls="json" aria-selected="false">JSON</a>
                    </li>
                    <li class="nav-item php-tab" style="display: none;">
                        <a class="nav-link" id="php-tab" data-bs-toggle="tab" href="#php" role="tab" aria-controls="php" aria-selected="false">PHP</a>
                    </li>
                </ul>
                <div class="tab-buttons json-buttons">
                    <button class="btn btn-primary" onclick="copyJSON()"><i class="fas fa-copy"></i> JSON 복사</button>
                    <button class="btn btn-secondary" onclick="saveJSON()"><i class="fas fa-save"></i> JSON 저장</button>
                </div>
                <div class="tab-buttons php-buttons">
                    <button class="btn btn-primary" onclick="copyPHP()"><i class="fas fa-copy"></i> PHP코드 복사</button>
                </div>
            </div>
            <div class="tab-pane fade show active" id="table" role="tabpanel" aria-labelledby="table-tab">
                <div id="table-container"></div>
            </div>
            <div class="tab-pane fade" id="json" role="tabpanel" aria-labelledby="json-tab">
                <pre><code id="json-output" class="language-json"></code></pre>
            </div>
            <div class="tab-pane fade" id="php" role="tabpanel" aria-labelledby="php-tab">
                <pre><code id="php-output" class="language-php"></code></pre>
            </div>
        </div>
    </div>
    <button id="scrollToTopBtn" class="btn btn-primary"><i class="fa-solid fa-arrow-up-from-bracket"></i></button>
    <!-- 사용 방법 모달 -->
    <div class="modal fade" id="usageModal" tabindex="-1" aria-labelledby="usageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="usageModalLabel">사용 방법</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>1. 파일 업로드</h6>
                    <p>
                        상단의 <strong>파일 선택</strong> 버튼을 클릭하거나, 
                        <strong>드래그 앤 드롭</strong>으로 Excel, CSV 또는 XML 파일을 업로드할 수 있습니다.
                    </p>
                    <h6>2. 이전 데이터 불러오기</h6>
                    <p>
                        이전에 작업한 데이터를 불러올 수 있습니다. 페이지를 새로 고침하거나 다시 방문하면, 
                        이전에 저장된 파일이 있는 경우 이를 불러올지 묻는 메시지가 표시됩니다. 
                        <strong>불러오기</strong> 버튼을 클릭하면 이전 데이터를 복원할 수 있습니다.
                    </p>
                    <h6>3. 컬럼 선택 및 헤더 행 지정</h6>
                    <p>
                        변환할 데이터를 포함한 컬럼을 클릭하여 선택합니다.  
                        <ul>
                            <li>컬럼을 선택하면 해당 컬럼이 포함된 행이 <strong>헤더 행</strong>으로 자동 지정됩니다.</li>
                            <li>선택되지 않은 컬럼을 클릭하면 해당 컬럼이 선택됩니다.</li>
                            <li>선택된 컬럼을 다시 클릭하면 해당 컬럼이 <strong>키 컬럼</strong>으로 지정됩니다.</li>
                            <li>키 컬럼은 한 번에 하나만 지정할 수 있습니다. 다른 컬럼을 키 컬럼으로 지정하면 이전에 지정된 키 컬럼은 해제됩니다.</li>
                            <li>키 컬럼을 다시 클릭하면 선택이 해제됩니다.</li>
                            <li>다른 행의 컬럼을 선택하면 이전에 선택한 컬럼은 모두 해제됩니다.</li>
                        </ul>
                    </p>
                    <h6>4. 변환</h6>
                    <p>
                        <strong>JSON으로 변환</strong> 버튼을 클릭하여 데이터를 JSON 형식으로 변환하거나, 
                        <strong>PHP코드로 변환</strong> 버튼을 클릭하여 데이터를 PHP 코드로 변환합니다.
                    </p>
                    <h6>5. 자료형 자동 변환</h6>
                    <p>
                        선택된 컬럼의 데이터는 자동으로 자료형이 변환됩니다:
                        <ul>
                            <li>숫자로만 구성된 데이터는 <strong>숫자형</strong>으로 변환됩니다.</li>
                            <li>`true` 또는 `false`로만 구성된 데이터는 <strong>불리언형</strong>으로 변환됩니다.</li>
                            <li>그 외의 데이터는 <strong>문자열</strong>로 변환됩니다.</li>
                        </ul>
                    </p>
                    <h6>6. 헤더 이름 확인 및 자료형 설정</h6>
                    <p>
                        데이터를 변환하기 전에, 선택된 컬럼의 <strong>헤더 이름</strong>과 <strong>자료형 자동 변환 여부</strong>를 확인할 수 있습니다:
                        <ul>
                            <li>컨펌창에서 각 컬럼의 헤더 이름을 수정할 수 있습니다. 단, <strong>키 컬럼</strong>은 수정할 수 없습니다.</li>
                            <li>각 컬럼 옆의 체크박스를 통해 <strong>자료형 자동 변환</strong> 여부를 설정할 수 있습니다.</li>
                            <li>체크박스를 해제하면 해당 컬럼의 데이터는 <strong>문자열</strong>로 변환됩니다.</li>
                            <li>중복된 헤더 이름이 있을 경우, 오류 메시지가 표시되며 수정이 필요합니다.</li>
                        </ul>
                    </p>
                    <h6>7. 결과 확인 및 저장</h6>
                    <p>변환된 데이터를 확인하고, 복사하거나 저장할 수 있습니다.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/x2js@3.4.4/x2js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.11/dist/dexie.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://kit.fontawesome.com/62adf6aecd.js" crossorigin="anonymous"></script>
    <script>
        let selectedFile;
        let workbook;
        let dragCounter = 0;
        let headerRowIndex = null;
        let selectedCols = [];
        let keyColIndex = null;
        let jsonObserver = null; // JSON IntersectionObserver를 위한 변수
        let phpObserver = null; // PHP IntersectionObserver를 위한 변수
        let fullJSON = null; // 전체 JSON 데이터를 저장할 변수
        let fullPHP = null; // 전체 PHP 코드를 저장할 변수
        
        // Dexie.js를 사용하여 IndexedDB 초기화
        const db = new Dexie("fileStorage");
        db.version(3).stores({
            files: "id,fileName,workbook"
        });

        // 페이지 로드 시 IndexedDB에서 데이터 복원
        $(document).ready(() => {
            db.files.get('fileData')
                .then((fileData) => {
                    if (fileData) {
                        Swal.fire({
                            title: '이전 데이터를 불러오시겠습니까?',
                            text: `이전에 저장된 파일 "${fileData.fileName}"이(가) 있습니다.`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: '불러오기',
                            cancelButtonText: '취소'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                showLoading();
                                $('#drop-area').hide().removeClass('highlight');
                                $('#file-name').text(`선택된 파일: ${fileData.fileName}`);
                                selectedFile = { name: fileData.fileName };
                                workbook = fileData.workbook;
                                populateSheetSelect();
                                hideLoading();
                            }
                        });
                    }
                })
                .catch((error) => {
                    console.error('IndexedDB 로드 오류:', error);
                });

                // 스크롤 이벤트 처리
                $(window).scroll(function() {
                    if ($(this).scrollTop() > 20) {
                        $('#scrollToTopBtn').fadeIn();
                    } else {
                        $('#scrollToTopBtn').fadeOut();
                    }
                });

                // 버튼 클릭 시 페이지 상단으로 스크롤
                $('#scrollToTopBtn').click(function() {
                    $('html, body').animate({ scrollTop: 0 }, 'smooth');
                    return false;
                });
        });

        // 드래그 앤 드롭 이벤트 처리
        $(document).on('dragenter', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragCounter++;
            $('#drop-area').show().addClass('highlight');
        });

        $(document).on('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragCounter--;
            if (dragCounter === 0) {
                $('#drop-area').hide().removeClass('highlight');
            }
        });

        $(document).on('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
        });

        $(document).on('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragCounter = 0;
            $('#drop-area').hide().removeClass('highlight');
            handleFiles(event.originalEvent.dataTransfer.files);
        });

        // 로딩 오버레이 표시 함수
        function showLoading() {
            $('#loading-overlay').show();
        }

        // 로딩 오버레이 숨김 함수
        function hideLoading(delay = 0) {
            setTimeout(() => {
                $('#loading-overlay').hide();
            }, delay);
        }

        // 로딩 오버레이와 함께 함수 실행
        function executeWithLoading(func) {
            showLoading();
            setTimeout(func, 0);
        }

        // 알림 표시 함수
        function showAlert(message, type = 'warning') {
            Swal.fire({
                icon: type,
                text: message,
                confirmButtonText: '닫기'
            });
        }

        // 파일 선택 처리
        function handleFiles(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                $('#file-name').text(`선택된 파일: ${selectedFile.name}`);
                resetUI();
                executeWithLoading(loadFile);
            }
        }

        // 파일 읽고 시트 선택 목록 채우기
        function loadFile() {
            const fileName = selectedFile.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = event.target.result;
                if (fileExtension === 'xml') {
                    const x2js = new X2JS();
                    const json = x2js.xml2js(data);

                    // JSON 데이터 내에서 배열을 탐색하여 첫 번째 배열을 찾는 함수
                    function findFirstArray(obj) {
                        if (Array.isArray(obj)) {
                            return obj;
                        }
                        if (typeof obj === 'object' && obj !== null) {
                            for (const key in obj) {
                                if (obj.hasOwnProperty(key)) {
                                    const result = findFirstArray(obj[key]);
                                    if (result) {
                                        return result;
                                    }
                                }
                            }
                        }
                        return null;
                    }

                    let jsonArray = findFirstArray(json);
                    if (!jsonArray) {
                        jsonArray = [json];
                    }
                    
                    const sheet = XLSX.utils.json_to_sheet(jsonArray);
                    workbook = { Sheets: { 'XML Data': sheet }, SheetNames: ['XML Data'] };
                } else {
                    const readOptions = {
                        type: fileExtension === 'csv' ? 'string' : 'array',
                        cellStyles: false // 스타일 정보를 무시하여 메모리 사용량을 줄임
                    };
                    if (fileExtension === 'csv') {
                        workbook = XLSX.read(data, readOptions);
                    } else {
                        workbook = XLSX.read(new Uint8Array(data), readOptions);
                    }
                }                
                populateSheetSelect();
                hideLoading();
                // 파일 데이터를 IndexedDB에 저장
                db.files.put({ id: 'fileData', fileName, workbook })
                    .catch((error) => {
                        console.error('IndexedDB 저장 오류:', error);
                    });
            };
            if (fileExtension === 'csv' || fileExtension === 'xml') {
                reader.readAsText(selectedFile);
            } else {
                reader.readAsArrayBuffer(selectedFile);
            }
        }

        // 시트 선택 목록 채우기
        function populateSheetSelect() {
            const sheetSelect = $('#sheet-select');
            sheetSelect.empty();
            sheetSelect.append($('<option>', {
                value: '',
                text: '시트 선택',
                disabled: true,
                hidden: true,
                selected: true
            }));
            workbook.SheetNames.forEach((sheetName, index) => {
                sheetSelect.append(new Option(sheetName, index));
            });
            $('.conversion-controls').show();
        }

        // 시트 표시
        function displaySheet() {
            const sheetIndex = $('#sheet-select').val();
            if (!sheetIndex) {
                showAlert('시트를 선택하세요.', 'warning');
                hideLoading();
                return;
            }

            // 시트 변경 시 초기화
            headerRowIndex = null;
            selectedCols = [];
            keyColIndex = null;

            const worksheet = workbook.Sheets[workbook.SheetNames[sheetIndex]];
            try {
                const tableHTML = XLSX.utils.sheet_to_html(worksheet);
                $('#table-container').html(tableHTML);
                const table = $('#table-container table');
                table.addClass('table table-striped table-bordered');

                // DataTables 초기화
                $(table).DataTable({
                    paging: true,
                    lengthChange: true,
                    lengthMenu: [ [25, 50, 100, -1], [25, 50, 100, "전체"] ],
                    pageLength: 25,
                    searching: true,
                    ordering: false,
                    info: true,
                    columns: Array.from({ length: table.find('tr:first td').length }, () => null),
                    language: {
                        decimal: "",
                        emptyTable: "표시할 데이터가 없음",
                        info: "총 _TOTAL_ 개 데이터 중 _START_ 부터 _END_ 까지 표시",
                        infoEmpty: "데이터 없음",
                        infoFiltered: "(총 _MAX_ 개 항목에서 검색됨)",
                        infoPostFix: "",
                        thousands: ",",
                        lengthMenu: "페이지당 _MENU_ 개 표시",
                        search: "검색:",
                        zeroRecords: "일치하는 데이터 없음",
                    }
                });

                // 기존 이벤트 핸들러 제거
                $('#table-container').off('click', 'td');

                // 이벤트 위임을 사용하여 td 클릭 이벤트 추가
                $('#table-container').on('click', 'td', function() {
                    const colIndex = $(this).index();
                    const rowIndex = $(this).closest('tr').index();

                    if (headerRowIndex === null || headerRowIndex !== rowIndex) {
                        headerRowIndex = rowIndex;
                        selectedCols = [colIndex];
                        keyColIndex = null;
                        table.find('td.selected').removeClass('selected');
                        table.find('td.data-row').removeClass('data-row');
                        table.find('.key-icon').remove();
                        $(this).addClass('selected');
                    } else {
                        if (selectedCols.includes(colIndex)) {
                            if ($(this).find('.key-icon').length > 0) {
                                // Key 아이콘 제거 및 선택 해제
                                $(this).find('.key-icon').remove();
                                keyColIndex = null;
                                selectedCols = selectedCols.filter(index => index !== colIndex);
                                $(this).removeClass('selected');
                            } else {
                                // Key 아이콘 추가
                                table.find('.key-icon').remove();
                                $(this).append('<i class="fas fa-key key-icon"></i>');
                                keyColIndex = colIndex;
                            }
                        } else {
                            selectedCols.push(colIndex);
                            $(this).addClass('selected');
                        }
                    }

                    // 데이터 행 하이라이트
                    table.find('tr').each(function(index) {
                        const row = $(this);
                        row.find('td').each(function(tdIndex) {
                            if (index > headerRowIndex && selectedCols.includes(tdIndex)) {
                                $(this).addClass('data-row');
                            } else {
                                $(this).removeClass('data-row');
                            }
                        });
                    });
                });
                $('.conversion-method-group').show();
                hideLoading();
            } catch (error) {
                console.error('시트 데이터 변환 오류:', error);
                $('#table-container').html('<p>내용이 없습니다.</p>');
                $('.conversion-method-group').hide();
                hideLoading();
            }
            $('.tab-content').show();
            $('.json-tab').hide();
            $('.php-tab').hide();
            $('.json-buttons').hide();
            $('.php-buttons').hide();
            $('#table-tab').tab('show');
        }

        // JSON 데이터를 표시하는 함수
        function displayJSON(json) {
            const jsonOutput = $('#json-output');
            jsonOutput.empty(); // 기존 내용을 비움

            let currentIndex = 0;
            const chunkSize = 300; // 한 번에 로드할 데이터 개수
            const sentinelId = 'json-sentinel'; // 고유한 ID를 할당

            // 기존 observer 해제
            if (jsonObserver) {
                jsonObserver.disconnect();
            }

            // 데이터를 추가하는 함수
            function addData() {
                let endIndex;
                let chunk;
                let chunkStr;

                if (Array.isArray(json)) {
                    endIndex = Math.min(currentIndex + chunkSize, json.length);
                    chunk = json.slice(currentIndex, endIndex);
                    chunkStr = JSON.stringify(chunk, null, 2).slice(1, -2); // 배열의 대괄호 제거
                } else {
                    const keys = Object.keys(json);
                    endIndex = Math.min(currentIndex + chunkSize, keys.length);
                    chunk = keys.slice(currentIndex, endIndex).reduce((obj, key) => {
                        obj[key] = json[key];
                        return obj;
                    }, {});
                    chunkStr = JSON.stringify(chunk, null, 2).slice(1, -2); // 객체의 중괄호 제거
                }

                if (currentIndex === 0) {
                    jsonOutput.append(Array.isArray(json) ? `[${chunkStr}` : `{${chunkStr}`);
                } else {
                    jsonOutput.append(`, ${chunkStr}`);
                }
                currentIndex = endIndex;
                if (currentIndex >= (Array.isArray(json) ? json.length : Object.keys(json).length)) {
                    jsonOutput.append(Array.isArray(json) ? `\n]` : `\n}`);
                    jsonObserver.disconnect(); // 모든 데이터를 로드하면 감시 중지
                }
            }

            // Intersection Observer 설정
            jsonObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        addData();
                    }
                });
            }, {
                root: null, // viewport를 기준으로 감시
                rootMargin: '0px',
                threshold: 1.0 // 요소가 100% 보여질 때 addData 호출
            });

            // 감시 대상 요소 추가
            let sentinel = document.getElementById(sentinelId);
            if (!sentinel) {
                sentinel = document.createElement('div');
                sentinel.id = sentinelId;
                jsonOutput.after(sentinel);
            }
            jsonObserver.observe(sentinel);

            // 첫 번째 데이터 추가
            addData();
        }

        // PHP 데이터를 표시하는 함수
        function displayPHP(phpCode) {
            const phpOutput = $('#php-output');
            phpOutput.empty(); // 기존 내용을 비움

            let currentIndex = 0;
            const chunkSize = 3000; // 한 번에 로드할 데이터 개수
            const sentinelId = 'php-sentinel'; // 고유한 ID를 할당

            // 기존 observer 해제
            if (phpObserver) {
                phpObserver.disconnect();
            }

            // 데이터를 추가하는 함수
            function addData() {
                const endIndex = Math.min(currentIndex + chunkSize, phpCode.length);
                const chunk = phpCode.slice(currentIndex, endIndex);
                phpOutput.append(chunk);
                currentIndex = endIndex;
                if (currentIndex >= phpCode.length) {
                    phpObserver.disconnect(); // 모든 데이터를 로드하면 감시 중지
                }
            }

            // Intersection Observer 설정
            phpObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        addData();
                    }
                });
            }, {
                root: null, // viewport를 기준으로 감시
                rootMargin: '0px',
                threshold: 1.0 // 요소가 100% 보여질 때 addData 호출
            });

            // 감시 대상 요소 추가
            let sentinel = document.getElementById(sentinelId);
            if (!sentinel) {
                sentinel = document.createElement('div');
                sentinel.id = sentinelId;
                phpOutput.after(sentinel);
            }
            phpObserver.observe(sentinel);

            // 첫 번째 데이터 추가
            addData();
        }

        // JSON으로 변환
        function convertToJSON() {
            const sheetIndex = $('#sheet-select').val();
            if (!sheetIndex) {
                showAlert('시트를 선택하세요.', 'warning');
                hideLoading();
                return;
            }
            if (headerRowIndex === null) {
                showAlert('헤더 행을 선택하세요.', 'warning');
                hideLoading();
                return;
            }
            const worksheet = workbook.Sheets[workbook.SheetNames[sheetIndex]];
            if (selectedCols.length === 0) {
                showAlert('적어도 하나의 컬럼을 선택하세요.', 'warning');
                hideLoading();
                return;
            }

            // 헤더 이름 확인 및 변경
            getHeadersWithConfirmation(worksheet, headerRowIndex, selectedCols, (autoTypeConversion) => {
                const json = customSheetToJsonWithHeader(worksheet, headerRowIndex, selectedCols, keyColIndex, autoTypeConversion);
                displayJSON(json);
                fullJSON = json; // 전체 JSON 데이터를 전역 변수에 저장
                $('.json-tab').show();
                $('.json-buttons').show();
                $('#json-tab').tab('show');
                hideLoading();
            });
        }

        // PHP 코드로 변환
        function convertToPHP() {
            const sheetIndex = $('#sheet-select').val();
            if (!sheetIndex) {
                showAlert('시트를 선택하세요.', 'warning');
                hideLoading();
                return;
            }
            if (headerRowIndex === null) {
                showAlert('헤더 행을 선택하세요.', 'warning');
                hideLoading();
                return;
            }
            const worksheet = workbook.Sheets[workbook.SheetNames[sheetIndex]];
            if (selectedCols.length === 0) {
                showAlert('적어도 하나의 컬럼을 선택하세요.', 'warning');
                hideLoading();
                return;
            }

            // 헤더 이름 확인 및 변경
            getHeadersWithConfirmation(worksheet, headerRowIndex, selectedCols, (autoTypeConversion) => {
                const json = customSheetToJsonWithHeader(worksheet, headerRowIndex, selectedCols, keyColIndex, autoTypeConversion);
                const phpCode = jsonToPHP(json);
                displayPHP(phpCode);
                fullPHP = phpCode; // 전체 PHP 코드를 전역 변수에 저장
                $('.php-tab').show();
                $('.php-buttons').show();
                $('#php-tab').tab('show');
                hideLoading();
            });
        }

        // 헤더 이름 확인 및 변경
        function getHeadersWithConfirmation(worksheet, headerRow, selectedCols, onConfirm) {
            const isKeyValueMode = selectedCols.length === 2 && keyColIndex !== null;

            // 키 컬럼 하나만 선택되었거나 키-밸류 형태인 경우 컨펌 창을 띄우지 않음
            if ((selectedCols.length === 1 && selectedCols[0] === keyColIndex) || isKeyValueMode) {
                onConfirm(selectedCols.map(() => true)); // 기본적으로 모든 컬럼에 대해 자동 변환 활성화
                hideLoading();
                return;
            }

            const headers = selectedCols.map((colIndex) => {
                const cell_address = { c: colIndex, r: headerRow };
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                return worksheet[cell_ref] ? worksheet[cell_ref].v : `Column_${colIndex + 1}`;
            });

            const inputFields = headers.map((header, index) => {
                const isKeyColumn = index === selectedCols.indexOf(keyColIndex);
                return `
                    <div class="swal2-header-container">
                        <label class="swal2-header-label">
                            ${isKeyColumn ? `<i class="fas fa-key key-icon"></i>` : ''}
                            ${header}
                        </label>
                        <input type="text" class="swal2-header-input" data-index="${index}" placeholder="${header}" value="${header}" ${isKeyColumn ? 'readonly' : ''}>
                        <input type="checkbox" class="swal2-header-checkbox" data-index="${index}" checked
                            title="자동으로 자료형을 변환합니다. 체크 해제 시 문자열로 변환됩니다.">
                    </div>
                `;
            }).join('');

            Swal.fire({
                title: '헤더 이름 확인 및 변경',
                html: `
                    <form id="header-form">
                        ${inputFields}
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: '확인',
                cancelButtonText: '취소',
                preConfirm: () => {
                    const inputs = document.querySelectorAll('.swal2-header-input:not([readonly])');
                    const checkboxes = document.querySelectorAll('.swal2-header-checkbox');
                    const newHeaders = Array.from(inputs).map(input => input.value.trim());
                    const autoTypeConversion = Array.from(checkboxes).map(checkbox => checkbox.checked);
                    const duplicates = findDuplicates(newHeaders);

                    // 모든 입력 필드의 배경색 초기화
                    inputs.forEach(input => input.classList.remove('error'));

                    if (duplicates.length > 0) {
                        duplicates.forEach(index => {
                            inputs[index].classList.add('error'); // 중복된 필드 배경색 변경
                        });
                        Swal.showValidationMessage('중복된 헤더 이름이 있습니다.');
                        return false;
                    }

                    // 키 컬럼의 헤더를 포함하여 반환
                    return {
                        headers: headers.map((header, index) => {
                            if (index === selectedCols.indexOf(keyColIndex)) {
                                return header; // 키 컬럼의 헤더는 변경하지 않음
                            }
                            return newHeaders.shift(); // 나머지 헤더는 사용자가 입력한 값으로 변경
                        }),
                        autoTypeConversion
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { headers: updatedHeaders, autoTypeConversion } = result.value;
                    updateHeaders(worksheet, headerRow, selectedCols, updatedHeaders);
                    onConfirm(autoTypeConversion); // 자료형 자동 변환 여부 전달
                } else {
                    hideLoading(); // 취소 시 로딩 숨김
                }
            });
        }

        // 중복 확인
        function findDuplicates(array) {
            const seen = {};
            const duplicates = [];
            array.forEach((item, index) => {
                if (seen[item]) {
                    duplicates.push(index);
                } else {
                    seen[item] = true;
                }
            });
            return duplicates;
        }

        // 헤더 업데이트
        function updateHeaders(worksheet, headerRow, selectedCols, newHeaders) {
            selectedCols.forEach((colIndex, index) => {
                const cell_address = { c: colIndex, r: headerRow };
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                worksheet[cell_ref] = { v: newHeaders[index] };
            });
        }

        // 시트 데이터를 JSON으로 변환
        function customSheetToJsonWithHeader(worksheet, headerRow, selectedCols, keyColIndex, autoTypeConversion) {
            let json;
            if (keyColIndex === null || (keyColIndex !== null && selectedCols.length === 1)) {
                json = [];
            } else {
                json = {};
            }

            const headers = selectedCols.map((colIndex) => {
                const cell_address = { c: colIndex, r: headerRow };
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                return worksheet[cell_ref] ? worksheet[cell_ref].v : `Column_${colIndex + 1}`;
            });

            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const columnTypes = {}; // 각 컬럼의 자료형 저장

            // 각 컬럼의 자료형 결정
            selectedCols.forEach((colIndex, index) => {
                if (!autoTypeConversion[index]) {
                    columnTypes[headers[index]] = 'string'; // 자동 변환 비활성화 시 문자열로 처리
                    return;
                }

                const values = [];
                for (let R = headerRow + 1; R <= range.e.r; ++R) {
                    const cell_address = { c: colIndex, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (worksheet[cell_ref]) {
                        values.push(worksheet[cell_ref].v);
                    }
                }

                // 자료형 결정
                const isAllNumbers = values.every(value => !isNaN(value) && value !== '');
                const isAllBooleans = values.every(value => value === 'true' || value === 'false');

                if (isAllNumbers) {
                    columnTypes[headers[index]] = 'number';
                } else if (isAllBooleans) {
                    columnTypes[headers[index]] = 'boolean';
                } else {
                    columnTypes[headers[index]] = 'string';
                }
            });

            // 데이터 변환
            for (let R = headerRow + 1; R <= range.e.r; ++R) {
                let row = {};
                let key = null;
                if (keyColIndex !== null) {
                    const keyCellAddress = { c: keyColIndex, r: R };
                    const keyCellRef = XLSX.utils.encode_cell(keyCellAddress);
                    key = worksheet[keyCellRef] ? worksheet[keyCellRef].v : null;

                    if (selectedCols.length === 1 && selectedCols[0] === keyColIndex) {
                        json.push(key);
                        continue;
                    }
                }
                selectedCols.forEach((colIndex, index) => {
                    if (colIndex === keyColIndex) return;
                    const cell_address = { c: colIndex, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (worksheet[cell_ref]) {
                        let value = worksheet[cell_ref].v;

                        // 자료형 변환
                        const columnType = columnTypes[headers[index]];
                        if (columnType === 'number') {
                            value = Number(value);
                        } else if (columnType === 'boolean') {
                            value = value === 'true';
                        } else if (columnType === 'string') {
                            value = String(value);
                        }

                        if (selectedCols.length === 2 && keyColIndex !== null) {
                            json[key] = value;
                        } else if (keyColIndex !== null) {
                            if (!json[key]) json[key] = {};
                            json[key][headers[index]] = value;
                        } else {
                            row[headers[index]] = value;
                        }
                    }
                });
                if (keyColIndex === null) {
                    json.push(row);
                }
            }
            return json;
        }

        // JSON을 PHP 코드로 변환
        function jsonToPHP(json) {
            function convertToPHPArray(obj, indent = 1) {
                let phpArray = "array(\n";
                const indentation = '    '.repeat(indent);
                for (const key in obj) {
                    const value = obj[key];
                    const phpKey = convertPHPKey(key); // 키의 자료형 변환
                    if (typeof value === 'object' && !Array.isArray(value)) {
                        phpArray += `${indentation}${phpKey} => ${convertToPHPArray(value, indent + 1)},\n`;
                    } else if (Array.isArray(value)) {
                        phpArray += `${indentation}${phpKey} => array(${value.map(item => convertPHPValue(item)).join(', ')}),\n`;
                    } else {
                        phpArray += `${indentation}${phpKey} => ${convertPHPValue(value)},\n`;
                    }
                }
                phpArray += `${'    '.repeat(indent - 1)})`;
                return phpArray;
            }

            function convertPHPKey(key) {
                if (!isNaN(key) && key !== '') {
                    return key; // 숫자형 키는 그대로 반환
                } else {
                    return `"${key}"`; // 문자열 키는 PHP 문자열로 변환
                }
            }

            function convertPHPValue(value) {
                if (typeof value === 'number') {
                    return value; // 숫자는 그대로
                } else if (typeof value === 'boolean') {
                    return value ? 'true' : 'false'; // 불리언 처리
                } else {
                    return `"${value}"`; // 문자열로 처리
                }
            }

            return `$data = ${convertToPHPArray(json)};`;
        }

        // JSON 복사
        function copyJSON() {
            const jsonStr = JSON.stringify(fullJSON, null, 2);
            navigator.clipboard.writeText(jsonStr).then(() => {
                showAlert('JSON이 클립보드에 복사되었습니다.', 'success');
            });
        }

        // JSON 저장
        function saveJSON() {
            const jsonStr = JSON.stringify(fullJSON, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // PHP 코드 복사
        function copyPHP() {
            const phpStr = fullPHP;
            navigator.clipboard.writeText(phpStr).then(() => {
                showAlert('PHP 코드가 클립보드에 복사되었습니다.', 'success');
            });
        }

        // UI 초기화
        function resetUI() {
            $('.tab-content').hide();
            $('.json-tab').hide();
            $('.php-tab').hide();
            $('.json-buttons').hide();
            $('.php-buttons').hide();
            $('.conversion-controls').hide();
            $('#table-container').empty();
            $('#sheet-select').val('');
            headerRowIndex = null;
            selectedCols = [];
            keyColIndex = null;
        }

        // 탭이 활성화될 때 버튼 표시
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'json-tab') {
                $('.json-buttons').show();
                $('.php-buttons').hide();
            } else if (e.target.id === 'php-tab') {
                $('.php-buttons').show();
                $('.json-buttons').hide();
            } else {
                $('.json-buttons').hide();
                $('.php-buttons').hide();
            }
        });
    </script>
</body>
</html>